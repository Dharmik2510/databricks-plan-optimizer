generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String    @id @default(cuid())
  email            String    @unique
  passwordHash     String
  name             String
  avatar           String?
  settings         Json      @default("{}")
  analysisCount    Int       @default(0)
  lastAnalysisAt   DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  lastLoginAt      DateTime?
  resetToken       String?   @unique
  resetTokenExpiry DateTime?
  isActive         Boolean   @default(true)

  // Authentication
  googleId          String?  @unique
  isVerified        Boolean  @default(false)
  verificationToken String?
  quotaLimit        Int      @default(100)
  role              UserRole @default(USER)

  // Relations
  analyses      Analysis[]
  chatSessions  ChatSession[]
  refreshTokens RefreshToken[]
  repositories  Repository[]

  // Observability relations
  userSessions      UserSession[]
  requestAudits     RequestAudit[]
  workflowRuns      WorkflowRun[]
  feedbacks         UserFeedback[]
  assignedFeedbacks UserFeedback[]  @relation("AssignedFeedback")
  feedbackEvents    FeedbackEvent[]

  @@index([email])
  @@index([role])
  @@map("users")
}

model Analysis {
  id                String         @id @default(cuid())
  userId            String
  title             String?
  inputType         InputType      @default(SPARK_PLAN)
  inputContent      String
  inputHash         String
  status            AnalysisStatus @default(PENDING)
  errorMessage      String?
  result            Json?
  severity          Severity?
  optimizationCount Int?
  dagNodeCount      Int?
  processingMs      Int?
  aiModel           String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  repoId            String?
  snapshotId        String?
  repo              Repository?    @relation("RepoAnalyses", fields: [repoId], references: [id])
  snapshot          RepoSnapshot?  @relation(fields: [snapshotId], references: [id])
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  chatSessions      ChatSession[]
  workflowRuns      WorkflowRun[]

  @@index([userId])
  @@index([userId, createdAt])
  @@index([inputHash])
  @@index([status])
  @@map("analyses")
}

model ChatSession {
  id           String        @id @default(cuid())
  userId       String
  analysisId   String?
  title        String?
  messageCount Int           @default(0)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  messages     ChatMessage[]
  analysis     Analysis?     @relation(fields: [analysisId], references: [id])
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([analysisId])
  @@map("chat_sessions")
}

model ChatMessage {
  id         String      @id @default(cuid())
  sessionId  String
  role       MessageRole
  content    String
  tokensUsed Int?
  createdAt  DateTime    @default(now())
  session    ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@map("chat_messages")
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  userAgent String?
  ipAddress String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model PricingCache {
  id            String   @id @default(cuid())
  cacheKey      String   @unique
  data          Json
  cloudProvider String
  region        String
  expiresAt     DateTime
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([cloudProvider, region])
  @@index([expiresAt])
  @@map("pricing_cache")
}

model Repository {
  id            String         @id @default(cuid())
  userId        String
  url           String
  name          String
  defaultBranch String         @default("main")
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  analyses      Analysis[]     @relation("RepoAnalyses")
  snapshots     RepoSnapshot[]
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("repositories")
}

model RepoSnapshot {
  id             String      @id @default(cuid())
  repoId         String
  commitHash     String
  branch         String      @default("main")
  collectionName String
  embeddingModel String
  schemaVersion  Int         @default(1)
  status         IndexStatus @default(PENDING)
  indexedAt      DateTime?
  lastUsedAt     DateTime    @default(now())
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  analyses       Analysis[]
  repo           Repository  @relation(fields: [repoId], references: [id], onDelete: Cascade)

  @@index([repoId])
  @@index([status])
  @@map("repo_snapshots")
}

model checkpoint_blobs {
  thread_id     String
  checkpoint_ns String @default("")
  channel       String
  version       String
  type          String
  blob          Bytes?

  @@id([thread_id, checkpoint_ns, channel, version])
}

model checkpoint_migrations {
  v Int @id
}

model checkpoint_writes {
  thread_id     String
  checkpoint_ns String  @default("")
  checkpoint_id String
  task_id       String
  idx           Int
  channel       String
  type          String?
  blob          Bytes

  @@id([thread_id, checkpoint_ns, checkpoint_id, task_id, idx])
}

model checkpoints {
  thread_id            String
  checkpoint_ns        String  @default("")
  checkpoint_id        String
  parent_checkpoint_id String?
  type                 String?
  checkpoint           Json
  metadata             Json    @default("{}")

  @@id([thread_id, checkpoint_ns, checkpoint_id])
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum InputType {
  SPARK_PLAN
  SQL_EXPLAIN
  LOG_FILE
}

enum AnalysisStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum Severity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

enum IndexStatus {
  PENDING
  INDEXING
  ACTIVE
  FAILED
  ARCHIVED
}

// ============================================
// OBSERVABILITY & USER FEEDBACK MODELS
// ============================================

model UserSession {
  id        String @id @default(cuid())
  sessionId String @unique
  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  deviceInfo Json?
  ipAddress  String?
  userAgent  String?

  createdAt      DateTime @default(now())
  lastActivityAt DateTime @updatedAt
  expiresAt      DateTime

  requestAudits RequestAudit[]
  feedbacks     UserFeedback[]

  @@index([userId])
  @@index([sessionId])
  @@index([createdAt])
  @@map("user_sessions")
}

model RequestAudit {
  id String @id @default(cuid())

  requestId     String  @unique
  correlationId String
  traceId       String?
  spanId        String?

  method     String
  path       String
  statusCode Int
  durationMs Int

  userId    String?
  user      User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  sessionId String?
  session   UserSession? @relation(fields: [sessionId], references: [sessionId], onDelete: SetNull)

  feature String

  analysisId    String?
  jobId         String?
  workflowRunId String?

  errorName    String?
  errorMessage String?
  errorCode    String?

  createdAt DateTime @default(now())

  @@index([requestId])
  @@index([correlationId])
  @@index([traceId])
  @@index([userId, createdAt])
  @@index([feature, createdAt])
  @@index([statusCode, createdAt])
  @@index([workflowRunId])
  @@map("request_audits")
}

model WorkflowRun {
  id String @id @default(cuid())

  workflowRunId String  @unique
  correlationId String
  traceId       String?

  workflowType String
  status       String

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  analysisId String?
  analysis   Analysis? @relation(fields: [analysisId], references: [id], onDelete: SetNull)
  jobId      String?

  input  Json
  output Json?
  error  Json?

  startedAt   DateTime  @default(now())
  completedAt DateTime?
  durationMs  Int?

  events    WorkflowEvent[]
  feedbacks UserFeedback[]

  @@index([workflowRunId])
  @@index([correlationId])
  @@index([traceId])
  @@index([userId, startedAt])
  @@index([workflowType, status])
  @@index([analysisId])
  @@index([jobId])
  @@index([status, startedAt])
  @@map("workflow_runs")
}

model WorkflowEvent {
  id String @id @default(cuid())

  workflowRunId String
  workflowRun   WorkflowRun @relation(fields: [workflowRunId], references: [workflowRunId], onDelete: Cascade)

  nodeId    String
  nodeName  String
  eventType String

  input    Json?
  output   Json?
  error    Json?
  metadata Json?

  timestamp  DateTime @default(now())
  durationMs Int?

  traceId String?
  spanId  String?

  @@index([workflowRunId, timestamp])
  @@index([nodeId])
  @@index([eventType, timestamp])
  @@index([traceId])
  @@map("workflow_events")
}

model UserFeedback {
  id       String @id @default(cuid())
  ticketId String @unique @default(cuid())

  userId    String
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionId String?
  session   UserSession? @relation(fields: [sessionId], references: [sessionId], onDelete: SetNull)

  title       String
  description String @db.Text
  severity    String
  category    String
  feature     String

  status       String   @default("new")
  assignedToId String?
  assignedTo   User?    @relation("AssignedFeedback", fields: [assignedToId], references: [id], onDelete: SetNull)
  tags         String[]

  correlationId String?
  traceId       String?
  requestId     String?
  workflowRunId String?
  workflowRun   WorkflowRun? @relation(fields: [workflowRunId], references: [workflowRunId], onDelete: SetNull)
  analysisId    String?
  jobId         String?

  pageUrl     String?
  userAgent   String?
  browserInfo Json?
  appVersion  String?
  lastAction  String?

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  resolvedAt DateTime?

  attachments FeedbackAttachment[]
  events      FeedbackEvent[]

  @@index([ticketId])
  @@index([userId, createdAt])
  @@index([status, severity, createdAt])
  @@index([feature, createdAt])
  @@index([assignedToId])
  @@index([correlationId])
  @@index([traceId])
  @@index([workflowRunId])
  @@index([analysisId])
  @@map("user_feedbacks")
}

model FeedbackAttachment {
  id         String       @id @default(cuid())
  feedbackId String
  feedback   UserFeedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)

  fileName   String
  fileType   String
  fileSize   Int
  storageUrl String

  isScreenshot   Boolean @default(false)
  screenshotMeta Json?

  uploadedAt DateTime @default(now())

  @@index([feedbackId])
  @@map("feedback_attachments")
}

model FeedbackEvent {
  id         String       @id @default(cuid())
  feedbackId String
  feedback   UserFeedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)

  eventType String

  authorId   String?
  author     User?   @relation(fields: [authorId], references: [id], onDelete: SetNull)
  isInternal Boolean @default(false)

  content  String? @db.Text
  metadata Json?

  createdAt DateTime @default(now())

  @@index([feedbackId, createdAt])
  @@index([eventType])
  @@map("feedback_events")
}
